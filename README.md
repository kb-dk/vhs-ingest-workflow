# VHS ingest workflow

The old digitisation workflow which used Hauppauge PVR cards to create mpeg2 files is now being replaced by the VHS2 workflow
which uses Hauppauge Colossus cards to encode to h.264 video. Because of the different architecture involved, there has been created
a new workflow `vhs2fileingest` in addition to the original `vhsfileingest` and `vhsclipingest` workflows.
These are Taverna workflows (see taverna folder) designed to ingest digitised VHS files and clips (ie whole programs)
into the SB digital repositories.

The original VHS file ingest workflow involves these steps
 * copy file
 * ffprobe file
 * get metadata
 * validate properties base on ffprobe output
 * checksum file
 * ingest into Bit Storage
 * package metadata for Doms
 * ingest into Doms
 
The `vhs2fileingest` workflow does need to copy the files over from the digitisation machine - they are assumed to be already available locally. 
The original `vhsfileingest` workflow takes a number of metadata fields as taverna input ports. In `vhs2fileingest` these are replaced by a reference
to a single json file containing the metadata generated by the digitisation processor component (digivid-processor) run by the human operator on the 
digitisation machine.
 
Each step in the taverna workflow is a Taverna Tool Invocation, which calls a bash script in the scripts folder or a beanshell script inlined in the
workflow definition.

The scripts depend on configurations found in the SB internal VHSINGEST_CONFIG project.

The workflow can be tested using `integrationTests/runIntegrationTests.sh` . (This only tests the `vhs2fileingest` workflow.)

This can be run directly from maven on the developer's own machine:
    
    mvn integration-test -P integrationTestProfile -Denv.passwordlessKey=$HOME/.ssh/id_rsa

In normal usage, the entry point for the workflow is the utility script `startVHS2Workflow.sh` . (Run with no arguments for usage information.)


## Comments File JSON

See `VideoFileObject.java` in [https://github.com/statsbiblioteket/digivid-processor] project and 
[https://sbprojects.statsbiblioteket.dk/display/VIDDIG/Metadata+Model] for all details.

Example:

    {"filename":"dr1_digivid_1301643600-2011-04-01-09.40.00_1427911200-2015-04-01-20.00.00.ts",
    "encoderName":"PC670","startDate":1301643600000,"endDate":1427911200000,"channel":"dr1",
    "checksum":"130cd70f6a8079ae637df3e06a74c16324393180","quality":"5 (Average Quality"}

